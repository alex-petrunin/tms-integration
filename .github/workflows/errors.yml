name: Simple Failure Demo

on:
  workflow_dispatch:
    inputs:
      triggerSource:
        description: "Source of trigger"
        required: false
        default: "automated_test_run"
      testCaseId:
        description: "Test Case ID"
        required: true
      testRunId:
        description: "Test Run ID (parent suite)"
        required: true
      individualTestRunId:
        description: "Individual Test Run ID (specific test case run)"
        required: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run npm test (will fail)
        id: tests
        run: |
          echo "Running npm test..."
          if npm test > test_output.log 2>&1; then
            echo "test_status=success" >> $GITHUB_OUTPUT
            echo "error_output=" >> $GITHUB_OUTPUT
          else
            EXIT_CODE=$?
            echo "Tests failed with exit code $EXIT_CODE"
            echo "test_status=failure" >> $GITHUB_OUTPUT
            echo "error_output<<EOF" >> $GITHUB_OUTPUT
            cat test_output.log >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Notify TMS App
        if: always()
        uses: ./.github/actions/notify-tms
        with:
          triggerSource: ${{ github.event.inputs.triggerSource }}
          testCaseId: ${{ github.event.inputs.testCaseId }}
          testRunId: ${{ github.event.inputs.testRunId }}
          totalTests: 5
          passedTests: 3
          failedTests: 2
          failedTestsList: "Critical business logic test, Integration test - payment gateway"
          callbackUrl: ${{ secrets.WEBHOOK_URL }}
          youtrackToken: ${{ secrets.YOUTRACK_TOKEN }}
