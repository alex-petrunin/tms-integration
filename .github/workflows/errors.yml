name: Unhappy Pass Test for TMS

on:
  workflow_dispatch:
    inputs:
      triggerSource:
        description: "Source of trigger (YT issue ID, test repo, etc.)"
        required: false
      testCaseId:
        description: "Original Test Case ID"
        required: true
      testRunId:
        description: "Test Run ID (parent suite)"
        required: true
      individualTestRunId:
        description: "Individual Test Run ID (specific test case run)"
        required: false

jobs:
  auto-fail-test:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Show test context
        run: |
          echo "ðŸ§ª Auto-Fail Test Starting..."
          echo "Test Case ID: ${{ github.event.inputs.testCaseId }}"
          echo "Test Run ID: ${{ github.event.inputs.testRunId }}"
          echo "Trigger Source: ${{ github.event.inputs.triggerSource }}"
          echo "Repository: ${{ github.repository }}"
          echo "Run ID: ${{ github.run_id }}"

      - name: Run failing tests
        id: tests
        run: |
          echo "ðŸš€ Starting test execution..."
          echo "Setting up test environment..."
          sleep 1
          
          echo "Running test suite..."
          echo "âœ… Test 1: User authentication - PASSED"
          echo "âœ… Test 2: Data validation - PASSED"
          echo "âœ… Test 3: API endpoints - PASSED"
          sleep 1
          
          echo "âŒ Test 4: Critical business logic - FAILED"
          echo "   Expected: user.isActive = true"
          echo "   Actual: user.isActive = false"
          echo "   AssertionError: User should be active after registration"
          
          echo "âŒ Test 5: Integration test - FAILED"
          echo "   Error: Connection timeout to external service"
          echo "   Details: Unable to connect to payment gateway after 30 seconds"
          
          echo ""
          echo "ðŸ“Š Test Results Summary:"
          echo "   Total: 5 tests"
          echo "   Passed: 3"
          echo "   Failed: 2"
          echo "   Success Rate: 60%"
          echo ""
          echo "ðŸ’¥ Test suite failed - 2 critical failures detected"
          
          # Set outputs for TMS notification
          echo "test_status=failure" >> $GITHUB_OUTPUT
          echo "error_output<<EOF" >> $GITHUB_OUTPUT
          echo "Critical business logic test, Integration test - payment gateway" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Exit with failure so job.status = failure
          exit 1

      - name: Notify TMS App
        if: always()
        uses: ./.github/actions/notify-tms
        with:
          triggerSource: ${{ github.event.inputs.triggerSource }}
          testCaseId: ${{ github.event.inputs.testCaseId }}
          testRunId: ${{ github.event.inputs.testRunId }}
          individualTestRunId: ${{ github.event.inputs.individualTestRunId }}
          totalTests: 5
          passedTests: 3
          failedTests: 2
          failedTestsList: "${{ steps.tests.outputs.error_output }}"
          callbackUrl: ${{ secrets.WEBHOOK_URL }}
          youtrackToken: ${{ secrets.YOUTRACK_TOKEN }}
        env:
          CALLBACK_URL: ${{ secrets.WEBHOOK_URL }}
          YOUTRACK_TOKEN: ${{ secrets.YOUTRACK_TOKEN }}
